<!DOCTYPE html>
<html>
<head>
    <title>Test Rapace WebSocket</title>
</head>
<body>
    <h1>Testing Rapace over WebSocket</h1>
    <div id="status">Connecting...</div>
    <pre id="output"></pre>

    <script>
        const output = document.getElementById('output');
        const status = document.getElementById('status');

        function log(msg) {
            output.textContent += msg + '\n';
            console.log(msg);
        }

        // Rapace WebSocket Test
        class SimpleRapaceClient {
            constructor(url) {
                this.url = url;
                this.ws = null;
                this.channelId = 1;
            }

            async connect() {
                return new Promise((resolve, reject) => {
                    this.ws = new WebSocket(this.url);
                    this.ws.binaryType = 'arraybuffer';

                    this.ws.onopen = () => {
                        log('âœ… WebSocket connected');
                        status.textContent = 'Connected';
                        resolve();
                    };

                    this.ws.onerror = (error) => {
                        log('âŒ WebSocket error: ' + error);
                        status.textContent = 'Error';
                        reject(error);
                    };

                    this.ws.onmessage = (event) => {
                        log('ðŸ“¨ Received message, size: ' + event.data.byteLength + ' bytes');

                        const view = new DataView(event.data);
                        const channelId = view.getUint32(0, true);
                        const methodId = view.getUint32(4, true);

                        log(`Channel ID: ${channelId}, Method ID: ${methodId}`);

                        // Extract payload
                        const payload = new Uint8Array(event.data, 8);
                        const json = new TextDecoder().decode(payload);

                        try {
                            const data = JSON.parse(json);
                            log('Response data: ' + JSON.stringify(data, null, 2));

                            if (Array.isArray(data)) {
                                status.textContent = `Connected - Found ${data.length} traces`;
                            }
                        } catch (e) {
                            log('Failed to parse JSON: ' + e);
                            log('Raw response: ' + json);
                        }
                    };

                    this.ws.onclose = () => {
                        log('WebSocket closed');
                        status.textContent = 'Disconnected';
                    };
                });
            }

            async listTraces() {
                const channelId = this.channelId++;
                const methodId = 2; // list_traces method

                // Build request payload (JSON for now)
                const request = {
                    service: null,
                    min_duration_nanos: null,
                    max_duration_nanos: null,
                    has_errors: null,
                    limit: 100
                };
                const json = JSON.stringify(request);
                const payload = new TextEncoder().encode(json);

                // Build frame: [descriptor][payload]
                const frame = new ArrayBuffer(8 + payload.byteLength);
                const view = new DataView(frame);

                view.setUint32(0, channelId, true);
                view.setUint32(4, methodId, true);

                new Uint8Array(frame, 8).set(payload);

                log(`ðŸ“¤ Sending list_traces request (channel=${channelId}, method=${methodId})`);
                this.ws.send(frame);
            }
        }

        // Test
        (async () => {
            try {
                const client = new SimpleRapaceClient('ws://127.0.0.1:1990/');
                await client.connect();

                // Wait a moment then list traces
                setTimeout(() => {
                    log('\nðŸ“‹ Requesting trace list...');
                    client.listTraces();
                }, 1000);
            } catch (error) {
                log('Test failed: ' + error);
                status.textContent = 'Failed';
            }
        })();
    </script>
</body>
</html>
